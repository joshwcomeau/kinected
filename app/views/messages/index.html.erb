<div class="message-wrapper">
  <div class="messages-title-bar">
    <h2>Messages Index</h2>
  </div>
  
  <nav>
    <ul>
      <li class="selected">All</li>
      <li>Sent</li>
      <li>Received</li>
    </ul>
  </nav>
    <section class="messages-box">
      <table>
        <% @messages.each do |m| %>
          <tr class="inbox-message-row <%= 'unread' if inbound?(m) && unread?(m) %>">
            <td class="message-dir">
              <% if outbound?(m) %>
                <%= fa_icon 'arrow-left' %>
              <% else %>
                <%= fa_icon 'arrow-right' %>
              <% end %>
            </td>
            <td class="message-thumbnail-cell">
              <div class="message-thumbnail" style="background-image:url(<%= asset_path m.user.primary_profile_photo_thumb %>);">
                <%= image_tag 'spacer.gif', class: 'full-width-and-height' %>
              </div>
            </td>
            <td>
              <h4 class="user_name"><%= m.user.display_name %> would like to kinect with you</h4>
              <p class="message_preview"><%= m.body %></p>
            </td>
            <td>
              <!-- I'm pretty sick of nested 'if' statements, so I'm doing this in a more verbose way -->
              <% if m.has_been_accepted? %>
                <%= link_to "Go To Chat", chat_path(m.user), class: 'chat-link' %>
              <% elsif outbound?(m) && m.queued? %>
                Message is Queued.
              <% elsif outbound?(m) %>
                Awaiting Reply.
              <% elsif inbound?(m) %>
                Rejected. <%= link_to "Undo" %>
              <% else %>
                <%= form_for Permission.new do |p| %>
                  <%= p.hidden_field :user_id, value: current_user.id %>
                  <%= p.hidden_field :target_user_id, value: m.user.id %>
                  <%= p.hidden_field :message_id, value: m.id %>
                  <%= p.hidden_field :status, value: 'allowed' %>
                  <%= p.submit "Accept", class: 'accept-button' %>
                <% end %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </table>
    </section> 

  </div>  
</div>
